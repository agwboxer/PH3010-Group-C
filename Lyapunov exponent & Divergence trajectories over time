# -*- coding: utf-8 -*-
"""
Created on Fri Nov 15 12:03:26 2024

@author: H Rogers
"""

import matplotlib.pyplot as plt
import numpy as np
from scipy.integrate import solve_ivp

# Define Mercury's orbit equations in terms of position and velocity for simplicity
def mercury_orbit(t, state):
    x, vx, y, vy = state
    r = np.sqrt(x**2 + y**2)
    # Gravitational constant times mass of the Sun (in AU^3/yr^2)
    GM = 4 * np.pi**2
    # Equations of motion
    ax = -GM * x / r**3
    ay = -GM * y / r**3
    return [vx, ax, vy, ay]

# Initial conditions for Mercury's orbit (position in AU, velocity in AU/year)
initial_state = [0.39, 0, 0, 9.96]  # Mercury's average orbital radius and velocity

# Solving the orbit over a certain time period
time_span = (0, 1)  # 1 year for simplicity
time_eval = np.linspace(0, 1, 1000)
solution = solve_ivp(mercury_orbit, time_span, initial_state, t_eval=time_eval)

# x position and x velocity
x_position = solution.y[0]
x_velocity = solution.y[1]

# Plotting the 2D phase space: x position vs. x velocity
plt.figure(figsize=(8, 6))
plt.plot(x_position, x_velocity, color="green")
plt.title("2D Phase Space: Mercury's x Position vs. x Velocity")
plt.xlabel("x Position (AU)")
plt.ylabel("x Velocity (AU/year)")
plt.grid()
plt.show()

# I defined a small perturbation to initial conditions
perturbation = 1e-5  # Small change in initial velocity

# Initial conditions for the perturbed orbit
initial_state_perturbed = [0.39, 0, 0, 9.96 + perturbation]

# Solving for both the original and perturbed orbits
solution_original = solve_ivp(mercury_orbit, time_span, initial_state, t_eval=time_eval)
solution_perturbed = solve_ivp(mercury_orbit, time_span, initial_state_perturbed, t_eval=time_eval)

# Calculating the separation (distance) between the two trajectories over time
x_diff = solution_perturbed.y[0] - solution_original.y[0]
y_diff = solution_perturbed.y[2] - solution_original.y[2]
separation = np.sqrt(x_diff**2 + y_diff**2)

# I added a small threshold to avoid log(0) or very small separations causing issues
threshold = 1e-10  # Small value to avoid division by zero
separation = np.maximum(separation, threshold)  # Ensurig separation never goes below threshold

# Calculating the rough estimate of the Lyapunov exponent
lyapunov_exponent = np.log(separation / separation[0]) / time_eval

# Plotting the separation over time
plt.figure(figsize=(8, 6))
plt.plot(time_eval, separation, label="Separation (Perturbation)")
plt.yscale("log")
plt.title("Divergence of Trajectories Over Time")
plt.xlabel("Time (years)")
plt.ylabel("Separation (AU)")
plt.legend()
plt.grid()
plt.show()

# the estimated Lyapunov exponent (last value)
print(f"Estimated Lyapunov Exponent: {lyapunov_exponent[-1]}")
